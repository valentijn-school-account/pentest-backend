package api

import (
	"github.com/gofiber/fiber/v2"
	"net/http"
	"pentest-backend/api/controllers/guest"
	user2 "pentest-backend/api/controllers/user"
	"pentest-backend/api/controllers/user/projects"
	"pentest-backend/api/middleware"
)

func StartServer() {
	app := fiber.New() // Creates an instance of fiber

	//TODO: route groups here

	//Guest route
	app.Get("/", func(ctx *fiber.Ctx) error { return ctx.SendStatus(http.StatusAccepted) })
	app.Post("/login", guest.HandleLogin)

	//User route
	user := app.Group("/user")
	user.Use(middleware.VerifyCookie)
	app.Get("/", func(ctx *fiber.Ctx) error { return ctx.SendStatus(http.StatusAccepted) })
	app.Get("/account", user2.HandleAccountInformation)
	app.Get("/projects", projects.HandleIndexProjects)

	project := user.Group("/project/:project")
	project.Use(middleware.InjectProject)
	project.Get("/", projects.HandleGetProject)
	project.Post("/init", projects.HandleInitializationProject)
	project.Post("/start", projects.HandleStartContainer)
	project.Post("/logs", projects.HandleLogsProject)

	step := project.Group("/step/:step")
	step.Use(middleware.InjectSteps)
	step.Post("/complete", projects.HandleNextStep)

	err := app.Listen(":8080") //Creates an app on HTTP port 8080

	if err != nil {
		return
	}
}
