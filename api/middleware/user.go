package middleware

import (
	"fmt"
	"github.com/dgrijalva/jwt-go"
	"github.com/gofiber/fiber/v2"
	"net/http"
	"pentest-backend/database"
	"pentest-backend/database/models"
	"pentest-backend/remote/google"
)

// VerifyCookie => Test to verify if the user is authenticated.
func VerifyCookie(c *fiber.Ctx) error {
	cookie := c.Cookies("authentication")

	//No cookie defined, first needs to log in.
	if cookie == "" {
		return c.Redirect("/")
	}

	claims := &google.GoogleClaims{}

	tkn, err := jwt.ParseWithClaims(cookie, claims, func(token *jwt.Token) (interface{}, error) {
		return []byte(google.JWTSecret), nil
	})

	//Verifying the contents of the cookie.
	if err != nil {
		return fiber.NewError(http.StatusInternalServerError, fmt.Sprintf("Could not parse cookie, %v", err))
	}

	if !tkn.Valid {
		return fiber.NewError(http.StatusUnauthorized, "Your session is invalid or expired.")
	}

	var user models.User
	database.Client.Table("users").Where(&models.User{Mail: claims.Email}).First(&user)

	if user.ID == 0 {
		return fiber.NewError(http.StatusNotFound, "Could not find profile data.")
	}

	var claim google.GoogleClaims
	claim = *claims

	//Passed the cookie test.
	c.Locals("user", claim)
	c.Locals("user_id", user.ID)

	return c.Next()
}
