package steps

import (
	"fmt"
	"github.com/gofiber/fiber/v2"
	"github.com/prometheus/client_golang/prometheus"
	"net/http"
	"pentest-backend/database"
	"pentest-backend/database/models"
	"pentest-backend/metrics"
	"time"
)

func HandleProjectCompletion(c *fiber.Ctx) error {
	flag := c.Params("flag")
	project := c.Locals("project").(models.Project)
	var progress models.Progress
	database.Client.Table("progress").Where(&models.Progress{UserID: c.Locals("user_id").(uint), ProjectID: project.ID}).First(&progress)

	if flag == "" {
		return fiber.NewError(http.StatusBadRequest, "No flag was given.")
	}

	if progress.ID == 0 {
		return fiber.NewError(http.StatusBadRequest, "You have not yet started the project.")
	}

	if progress.Completed {
		return fiber.NewError(http.StatusAlreadyReported, "This project has already been completed.")
	}

	if project.Flag != flag {
		return fiber.NewError(http.StatusNotAcceptable, "You entered the wrong flag, please try again.")
	}

	progress.Completed = true
	progress.UsedAt = time.Now()
	database.Client.Table("progress").Save(&progress).Where(&models.Progress{UserID: c.Locals("user_id").(uint), ProjectID: project.ID})
	metrics.UserExperience.With(prometheus.Labels{"day": time.Now().Weekday().String(), "date": time.Now().Format("2006-01-02"), "user": fmt.Sprintf("%v", c.Locals("user_id").(uint))}).Observe(float64(project.Difficulty.Experience()))

	var user models.User
	database.Client.Table("users").Where("id", c.Locals("user_id").(uint)).First(&user)
	user.Experience += project.Difficulty.Experience()
	database.Client.Table("users").Save(&user).Where("id", c.Locals("user_id").(uint))

	return c.SendStatus(http.StatusOK)
}
