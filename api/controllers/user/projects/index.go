package projects

import (
	"github.com/gofiber/fiber/v2"
	"pentest-backend/database"
	"pentest-backend/database/models"
)

type ProjectResult struct {
	models.Project
	models.Progress
	Description string        `json:"description"`
	Steps       []models.Step `json:"steps"`
}

//Route: /user/projects
func HandleIndexProjects(c *fiber.Ctx) error {
	var results []ProjectResult
	var projects []models.Project

	database.Client.Table("projects").Find(&projects)

	for _, project := range projects {
		var result ProjectResult
		var steps []models.Step
		var progress models.Progress
		result.Project = project
		database.Client.Table("steps").Where("project_id", project.ID).Find(&steps)
		result.Steps = steps
		database.Client.Table("progress").Where(&models.Progress{UserID: c.Locals("user_id").(uint), ProjectID: project.ID}).First(&progress)
		result.Progress = progress
		results = append(results, result)
	}

	return c.JSON(&results)
}
